#include <sys/time.h>
#include <stdlib.h>
#include <stdio.h>
#include <fcntl.h>

char banner[] = {
  0x20, 0x5f, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x5f, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x5f, 0x20, 0x20, 0x5f, 0x20, 0x20, 0x20,
  0x0a, 0x7c, 0x20, 0x7c, 0x20, 0x20, 0x20, 0x5f, 0x20, 0x20, 0x20, 0x5f,
  0x20, 0x20, 0x5f, 0x5f, 0x5f, 0x7c, 0x20, 0x7c, 0x20, 0x5f, 0x5f, 0x5f,
  0x20, 0x20, 0x20, 0x5f, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x20, 0x7c, 0x7c, 0x20, 0x7c, 0x20,
  0x20, 0x0a, 0x7c, 0x20, 0x7c, 0x20, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x7c,
  0x20, 0x7c, 0x2f, 0x20, 0x5f, 0x5f, 0x7c, 0x20, 0x7c, 0x2f, 0x20, 0x2f,
  0x20, 0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x20, 0x7c, 0x7c, 0x20, 0x7c,
  0x5f, 0x20, 0x0a, 0x7c, 0x20, 0x7c, 0x5f, 0x5f, 0x7c, 0x20, 0x7c, 0x5f,
  0x7c, 0x20, 0x7c, 0x20, 0x28, 0x5f, 0x5f, 0x7c, 0x20, 0x20, 0x20, 0x3c,
  0x7c, 0x20, 0x7c, 0x5f, 0x7c, 0x20, 0x7c, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x5f, 0x5f, 0x20, 0x20,
  0x20, 0x5f, 0x7c, 0x0a, 0x7c, 0x5f, 0x5f, 0x5f, 0x5f, 0x5f, 0x5c, 0x5f,
  0x5f, 0x2c, 0x5f, 0x7c, 0x5c, 0x5f, 0x5f, 0x5f, 0x7c, 0x5f, 0x7c, 0x5c,
  0x5f, 0x5c, 0x5c, 0x5f, 0x5f, 0x2c, 0x20, 0x7c, 0x5f, 0x5f, 0x5f, 0x5f,
  0x20, 0x5f, 0x5f, 0x5f, 0x5f, 0x5f, 0x20, 0x5f, 0x5f, 0x5f, 0x5f, 0x7c,
  0x5f, 0x7c, 0x20, 0x20, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x7c, 0x5f, 0x5f, 0x5f, 0x2f, 0x5f, 0x5f, 0x5f, 0x5f,
  0x5f, 0x7c, 0x5f, 0x5f, 0x5f, 0x5f, 0x5f, 0x7c, 0x5f, 0x5f, 0x5f, 0x5f,
  0x5f, 0x7c, 0x20, 0x20, 0x20, 0x0a, 0x0
};

#define FIRST_PRINTABLE 		'A'
#define LAST_PRINTABLE 		'z'

#define PASS_LEN		32
#define LIVES			4



void seed_rng()
{
	unsigned int seed;
	int urnd = open("/dev/urandom", O_RDONLY);
	if (urnd < 0)
		exit(-1);
	if (read(urnd, &seed, 4) != 4)
		exit(-1);
	srand(seed);
}


void set_passwd(char *passwd, int len)
{
	size_t i,interv_size = LAST_PRINTABLE - FIRST_PRINTABLE + 1;
	seed_rng();
	for (i = 0; i < len; i++)
		passwd[i] = rand() % interv_size + FIRST_PRINTABLE;
	passwd[len] = '\0';

}


int lives = LIVES;

void win()
{
	system("/bin/cat /home/lucky_4/flag");
	exit(-1);
}

void play(unsigned char *passwd, int len){

	puts(banner);
	printf("Let's play! The rules are simple:\n\t You start with %d lives.\n\t You need to guess my secret password byte-by-byte.\n\t A wrong answer will cost you a life but will reveal that specific byte\n", LIVES);
	printf("Are you ready?\n");
	if (getchar() != 'Y') {
		printf("Apparently not! Come again when you're ready...\n");
		exit(-1);
	}
	printf("Of course you are! Here we go.\n");

	while (lives > 0) {
		unsigned int offset;
		unsigned int byte;
		printf("What offset do you want to guess?\n");
		scanf("%u", &offset);
		// protect sensitive stack data
		if (offset > len && offset < 0xFFFF) {
			printf("No funny business please.\n");
			exit(-1);
		}
		printf("OK! insert byte (hex form)\n");
		scanf("%02X", &byte);
		passwd[offset] ^= byte;
		if (passwd[offset] == 0) {
			int i,flag = 0;
			printf("Well done!\n");
			for (i = 0 ; i < len; i++){
				if (passwd[i] != 0)
					flag = 1;
			}
			if (flag == 0) {
				printf("You win!\n");
				win();
			}
		} else {
			lives--;
			printf("Ouch. That byte is now %02X instead of 00.\n\t You now have %d lives.\n", passwd[offset], lives);
		}
	}
	printf("You lose!\n");
}



int main()
{
	alarm(15);
        setbuf(stdin,0);
        setbuf(stdout,0);
	char passwd[PASS_LEN + 1];
	set_passwd(passwd, PASS_LEN);

	play((unsigned char*)passwd, PASS_LEN);


	return 0;
}
